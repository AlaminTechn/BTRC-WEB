version: '3.8'

# BTRC QoS Monitoring System - Docker Compose
#
# Prerequisites:
#   1. Copy .env.example to .env
#   2. Update values in .env as needed
#
# Usage (use 'docker compose' v2 syntax):
#   Start all services:     docker compose up -d
#   Start database only:    docker compose up -d btrc-db
#   Load data:              docker compose run --rm data-loader
#   Initialize Superset:    docker compose up superset-init
#   View logs:              docker compose logs -f superset
#   Stop all:               docker compose down
#   Remove volumes:         docker compose down -v

services:
  # Main BTRC Database with TimescaleDB
  btrc-db:
    image: timescale/timescaledb:latest-pg15
    container_name: btrc-db
    restart: unless-stopped
    ports:
      - "${POSTGRES_EXTERNAL_PORT:-5434}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    env_file:
      - .env
    volumes:
      - btrc_db_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-btrc} -d ${POSTGRES_DB:-btrc_qos}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Data Loader - Loads JSON data into database
  data-loader:
    build:
      context: .
      dockerfile: Dockerfile.dataloader
    container_name: btrc-data-loader
    env_file:
      - .env
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=${POSTGRES_HOST:-btrc-db}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
    volumes:
      - ./dummy_data_v:/app/dummy_data_v:ro
    depends_on:
      btrc-db:
        condition: service_healthy
    restart: "no"

  # Redis for Superset caching
  redis:
    image: redis:7-alpine
    container_name: superset-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Superset Metadata Database
  superset-db:
    image: postgres:15-alpine
    container_name: superset-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${SUPERSET_DB_USER:-superset}
      - POSTGRES_PASSWORD=${SUPERSET_DB_PASSWORD:-superset}
      - POSTGRES_DB=${SUPERSET_DB_NAME:-superset}
    env_file:
      - .env
    volumes:
      - superset_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SUPERSET_DB_USER:-superset} -d ${SUPERSET_DB_NAME:-superset}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Apache Superset
  superset:
    image: apache/superset:3.1.0
    container_name: btrc-superset
    restart: unless-stopped
    ports:
      - "8088:8088"
    environment:
      - SUPERSET_SECRET_KEY=${SUPERSET_SECRET_KEY}
      - DATABASE_URL=postgresql://${SUPERSET_DB_USER:-superset}:${SUPERSET_DB_PASSWORD:-superset}@superset-db:5432/${SUPERSET_DB_NAME:-superset}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - FLASK_APP=superset
      - SUPERSET_LOAD_EXAMPLES=no
    env_file:
      - .env
    volumes:
      - superset_home:/app/superset_home
      - ./superset_config.py:/app/pythonpath/superset_config.py:ro
    depends_on:
      superset-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      btrc-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Superset Init - runs once to initialize
  superset-init:
    image: apache/superset:3.1.0
    container_name: superset-init
    environment:
      - SUPERSET_SECRET_KEY=${SUPERSET_SECRET_KEY}
      - DATABASE_URL=postgresql://${SUPERSET_DB_USER:-superset}:${SUPERSET_DB_PASSWORD:-superset}@superset-db:5432/${SUPERSET_DB_NAME:-superset}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    env_file:
      - .env
    volumes:
      - superset_home:/app/superset_home
      - ./superset_config.py:/app/pythonpath/superset_config.py:ro
    depends_on:
      superset-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      bash -c "
        echo 'Initializing Superset...' &&
        superset db upgrade &&
        superset fab create-admin \
          --username ${SUPERSET_ADMIN_USERNAME:-admin} \
          --firstname Admin \
          --lastname User \
          --email ${SUPERSET_ADMIN_EMAIL:-admin@btrc.gov.bd} \
          --password ${SUPERSET_ADMIN_PASSWORD:-admin123} || true &&
        superset init &&
        echo 'Superset initialization complete!'
      "
    restart: "no"

volumes:
  btrc_db_data:
    name: btrc_db_data
  superset_db_data:
    name: superset_db_data
  superset_home:
    name: superset_home
  redis_data:
    name: redis_data

networks:
  default:
    name: btrc-network
