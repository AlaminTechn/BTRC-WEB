version: '3.8'

services:
  # Main BTRC Database with TimescaleDB
  btrc-db:
    image: timescale/timescaledb:latest-pg15
    container_name: btrc-db
    restart: unless-stopped
    ports:
      - "5434:5432"
    environment:
      - POSTGRES_USER=btrc
      - POSTGRES_PASSWORD=btrc_password
      - POSTGRES_DB=btrc_qos
    volumes:
      - btrc_db_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U btrc -d btrc_qos"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Superset caching
  redis:
    image: redis:7-alpine
    container_name: superset-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Superset Metadata Database
  superset-db:
    image: postgres:15-alpine
    container_name: superset-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=superset
      - POSTGRES_PASSWORD=superset
      - POSTGRES_DB=superset
    volumes:
      - superset_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U superset -d superset"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Apache Superset
  superset:
    image: apache/superset:3.1.0
    container_name: btrc-superset
    restart: unless-stopped
    ports:
      - "8088:8088"
    environment:
      - SUPERSET_SECRET_KEY=btrc-qos-monitoring-secret-key-2026
      - DATABASE_URL=postgresql://superset:superset@superset-db:5432/superset
      - REDIS_URL=redis://redis:6379/0
      - FLASK_APP=superset
      - SUPERSET_LOAD_EXAMPLES=no
    volumes:
      - superset_home:/app/superset_home
      - ./superset_config.py:/app/pythonpath/superset_config.py:ro
    depends_on:
      superset-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      btrc-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Superset Init - runs once to initialize
  superset-init:
    image: apache/superset:3.1.0
    container_name: superset-init
    environment:
      - SUPERSET_SECRET_KEY=btrc-qos-monitoring-secret-key-2026
      - DATABASE_URL=postgresql://superset:superset@superset-db:5432/superset
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - superset_home:/app/superset_home
      - ./superset_config.py:/app/pythonpath/superset_config.py:ro
    depends_on:
      superset-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      bash -c "
        echo 'Initializing Superset...' &&
        superset db upgrade &&
        superset fab create-admin \
          --username admin \
          --firstname Admin \
          --lastname User \
          --email admin@btrc.gov.bd \
          --password admin123 || true &&
        superset init &&
        echo 'Superset initialization complete!'
      "
    restart: "no"

volumes:
  btrc_db_data:
    name: btrc_db_data
  superset_db_data:
    name: superset_db_data
  superset_home:
    name: superset_home
  redis_data:
    name: redis_data

networks:
  default:
    name: btrc-network
